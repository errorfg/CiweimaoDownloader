name: Build & Release (Windows EXE)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name (e.g. v1.0.0). Will create if not exists."
        required: true
      body:
        description: "Release description (Markdown allowed)"
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tags
        shell: pwsh
        run: |
          $tag = '${{ inputs.tag }}'
          try {
              if (-not (git rev-parse $tag -q --verify)) {
                  Write-Host "Tag $tag does not exist, creating..."
                  git tag $tag
                  git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} $tag
              } else {
                  Write-Host "Tag $tag already exists, skipping creation"
              }
          } catch {
              Write-Host "Git tag check/push returned non-zero, ignoring"
          }
          
          # **确保 step 不会因非零退出码失败**
          exit 0


      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      - name: Build Windows EXE with Nuitka
        shell: pwsh
        run: |
          try {
              python -m nuitka `
                --standalone `
                --onefile `
                --assume-yes-for-downloads `
                --remove-output `
                --output-dir=build `
                src/main.py
          } catch {
              Write-Host "Nuitka build failed"
              exit 1
          }

      - name: Prepare release files
        shell: pwsh
        run: |
          if (-Not (Test-Path release)) { New-Item -ItemType Directory -Path release }
          Copy-Item build\main.exe release\
          Copy-Item setting.yaml release\
          Copy-Item readme.md release\

      - name: Pack artifacts
        shell: pwsh
        run: |
          Compress-Archive -Path release\* -DestinationPath release\CiweimaoDownloader-${{ inputs.tag }}-windows-x64.zip -Force

      - name: Create Release & Upload
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.tag }}
          name: ${{ inputs.tag }}
          body: |
            ${{ inputs.body }}

            ---
            Built automatically via GitHub Actions
            Maintained by @Zn90107UlKa
          files: release\CiweimaoDownloader-${{ inputs.tag }}-windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
