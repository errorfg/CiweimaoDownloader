name: Build & Release (Windows EXE)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name (e.g. v1.0.0). Will create if not exists."
        required: true
      body:
        description: "Release description (Markdown allowed)"
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Ensure tag exists (‰∏ç‰ºöÂõ†‰∏∫Â∑≤Â≠òÂú®Â§±Ë¥•)
      - name: Ensure tag exists
        shell: pwsh
        run: |
          $tag = '${{ inputs.tag }}'
          try {
              if (-not (git rev-parse $tag -q --verify)) {
                  Write-Host "Tag $tag does not exist, creating..."
                  git tag $tag
                  git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} $tag
              } else {
                  Write-Host "Tag $tag already exists, skipping creation"
              }
          } catch {
              Write-Host "Git tag check/push returned non-zero, ignoring"
          }
          exit 0  # ÈÅøÂÖç step Âõ†ÈùûÈõ∂ÈÄÄÂá∫Á†Å fail

      # 3Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4Ô∏è‚É£ Cache pip (Windows ‰∏ãÊ≠£Á°ÆË∑ØÂæÑ)
      - name: Set pip cache dir
        shell: pwsh
        run: |
          echo "PIP_CACHE_DIR=$env:LOCALAPPDATA\pip\Cache" >> $env:GITHUB_ENV

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ${{ env.PIP_CACHE_DIR }}
          key: windows-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: windows-pip-

      # 5Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      # 6Ô∏è‚É£ Build Windows EXE with Nuitka
      - name: Build Windows EXE
        shell: pwsh
        run: |
          try {
              python -m nuitka `
                  --standalone `
                  --onefile `
                  --assume-yes-for-downloads `
                  --remove-output `
                  --output-dir=build `
                  src/main.py
          } catch {
              Write-Host "Nuitka build failed"
              exit 1
          }

      # 7Ô∏è‚É£ Prepare release files
      - name: Prepare release files
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force release
          New-Item -ItemType Directory -Force dist
          Copy-Item build\main.exe release\
          Copy-Item setting.yaml release\
          Copy-Item readme.md release\

      # 8Ô∏è‚É£ Pack artifacts into zip (dist folder)
      - name: Pack artifacts
        shell: pwsh
        run: |
          $zip = "dist\CiweimaoDownloader-${{ inputs.tag }}-windows-x64.zip"
          Compress-Archive -Path release\* -DestinationPath $zip -Force

      # 9Ô∏è‚É£ Debug (ÂèØÈÄâÔºåÁ°Æ‰øùÊñá‰ª∂ÁîüÊàê)
      - name: Debug packaged files
        shell: pwsh
        run: |
          Write-Host "=== release content ==="
          Get-ChildItem release -Recurse
          Write-Host "=== dist content ==="
          Get-ChildItem dist -Recurse

      # üîü Create Release & Upload
      - name: Create Release & Upload
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.tag }}
          name: ${{ inputs.tag }}
          body: |
            ${{ inputs.body }}
      
            ---
            Built automatically via GitHub Actions
            Maintained by @Zn90107UlKa
          files: dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
